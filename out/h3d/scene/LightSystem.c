// Generated by HLC 4.0.0 (HL v4)
#include <hl/code.h>

bool h3d_scene_LightSystem_get_additiveLighting(h3d__scene__LightSystem r0) {
	bool r1;
	h3d__shader__AmbientLight r4;
	h3d__shader__$AmbientLight r3;
	hxsl__Shader r2;
	r2 = r0->ambientShader;
	r3 = (h3d__shader__$AmbientLight)global$730;
	r1 = hl_BaseType_check(((hl__BaseType)r3),((vdynamic*)r2));
	if( !r1 ) goto label$1247$6;
	r4 = (h3d__shader__AmbientLight)r2;
	goto label$1247$7;
	label$1247$6:
	r4 = NULL;
	label$1247$7:
	if( r4 == NULL ) hl_null_access();
	r1 = r4->additive__;
	return r1;
}

bool h3d_scene_LightSystem_set_additiveLighting(h3d__scene__LightSystem r0,bool r1) {
	bool r5;
	h3d__shader__AmbientLight r4;
	h3d__shader__$AmbientLight r3;
	hxsl__Shader r2;
	r2 = r0->ambientShader;
	r3 = (h3d__shader__$AmbientLight)global$730;
	r5 = hl_BaseType_check(((hl__BaseType)r3),((vdynamic*)r2));
	if( !r5 ) goto label$1248$6;
	r4 = (h3d__shader__AmbientLight)r2;
	goto label$1248$7;
	label$1248$6:
	r4 = NULL;
	label$1248$7:
	if( r4 == NULL ) hl_null_access();
	r5 = true;
	r4->constModified = r5;
	r4->additive__ = r1;
	return r1;
}

void h3d_scene_LightSystem_initLights(h3d__scene__LightSystem r0,h3d__scene__RenderContext r1) {
	bool r16;
	h3d__col__Frustum r6;
	h3d__Camera r8;
	h3d__Vector r30;
	h3d__col__Sphere r9;
	h3d__scene__Light r3, r5, r14, r17, r20, r22, r23, r26, r28, r29;
	vclosure *r19;
	double r15;
	double *r10, *r11, *r12, *r13;
	h3d__Matrix r7;
	int r2, r18, r21, r24, r25, r27;
	r2 = 0;
	r0->lightCount = r2;
	r0->ctx = r1;
	if( r1 == NULL ) hl_null_access();
	r3 = r1->lights;
	r5 = NULL;
	r6 = (h3d__col__Frustum)hl_alloc_obj(h3d__col__Frustum__val);
	r8 = r1->camera;
	if( r8 == NULL ) hl_null_access();
	r7 = r8->m;
	h3d_col_Frustum_new(r6,r7);
	r9 = (h3d__col__Sphere)hl_alloc_obj(h3d__col__Sphere__val);
	r10 = NULL;
	r11 = NULL;
	r12 = NULL;
	r13 = NULL;
	h3d_col_Sphere_new(r9,r10,r11,r12,r13);
	label$1249$17:
	if( !r3 ) goto label$1249$60;
	if( r9 == NULL ) hl_null_access();
	if( r3 == NULL ) hl_null_access();
	r7 = r3->absPos;
	if( r7 == NULL ) hl_null_access();
	r15 = r7->_41;
	r9->x = r15;
	r7 = r3->absPos;
	if( r7 == NULL ) hl_null_access();
	r15 = r7->_42;
	r9->y = r15;
	r7 = r3->absPos;
	if( r7 == NULL ) hl_null_access();
	r15 = r7->_43;
	r9->z = r15;
	r15 = r3->cullingDistance;
	r9->r = r15;
	if( r1 == NULL ) hl_null_access();
	r16 = r1->computingStatic;
	if( r16 ) goto label$1249$51;
	if( r6 == NULL ) hl_null_access();
	r16 = h3d_col_Frustum_hasSphere(r6,r9);
	if( r16 ) goto label$1249$51;
	if( r5 ) goto label$1249$45;
	r14 = r3->next;
	r1->lights = r14;
	goto label$1249$48;
	label$1249$45:
	if( r5 == NULL ) hl_null_access();
	r17 = r3->next;
	r5->next = r17;
	label$1249$48:
	r14 = r3->next;
	r3 = r14;
	goto label$1249$17;
	label$1249$51:
	r2 = r0->lightCount;
	++r2;
	r0->lightCount = r2;
	r15 = 0.;
	r3->objectDistance = r15;
	r5 = r3;
	r14 = r3->next;
	r3 = r14;
	goto label$1249$17;
	label$1249$60:
	r2 = r0->lightCount;
	r18 = r0->maxLightsPerObject;
	if( r18 < r2 ) goto label$1249$156;
	if( r1 == NULL ) hl_null_access();
	r14 = r1->lights;
	r19 = hl_alloc_closure_ptr(&type$2646,h3d_scene_LightSystem_sortLight,r0);
	if( r14 ) goto label$1249$70;
	r20 = NULL;
	r17 = r20;
	goto label$1249$154;
	label$1249$70:
	r2 = 1;
	r18 = 0;
	r21 = 0;
	label$1249$73:
	r16 = true;
	if( !r16 ) goto label$1249$153;
	r20 = r14;
	r22 = NULL;
	r14 = r22;
	r23 = NULL;
	r22 = r23;
	r25 = 0;
	r24 = r25;
	label$1249$83:
	if( !r20 ) goto label$1249$143;
	++r24;
	r23 = r20;
	r25 = 0;
	r18 = r25;
	r25 = 0;
	r27 = r2;
	label$1249$91:
	if( r25 >= r27 ) goto label$1249$101;
	++r25;
	++r18;
	if( r23 == NULL ) hl_null_access();
	r26 = r23->next;
	r23 = r26;
	if( r26 ) goto label$1249$100;
	goto label$1249$101;
	label$1249$100:
	goto label$1249$91;
	label$1249$101:
	r21 = r2;
	label$1249$102:
	r27 = 0;
	if( r27 < r18 ) goto label$1249$108;
	r27 = 0;
	if( r27 >= r21 ) goto label$1249$141;
	if( !r23 ) goto label$1249$141;
	label$1249$108:
	r27 = 0;
	if( r18 != r27 ) goto label$1249$116;
	r26 = r23;
	if( r23 == NULL ) hl_null_access();
	r28 = r23->next;
	r23 = r28;
	--r21;
	goto label$1249$134;
	label$1249$116:
	r27 = 0;
	if( r21 == r27 ) goto label$1249$123;
	if( !r23 ) goto label$1249$123;
	if( r19 == NULL ) hl_null_access();
	r25 = r19->hasValue ? ((int (*)(vdynamic*,h3d__scene__Light,h3d__scene__Light))r19->fun)((vdynamic*)r19->value,r20,r23) : ((int (*)(h3d__scene__Light,h3d__scene__Light))r19->fun)(r20,r23);
	r27 = 0;
	if( r27 < r25 ) goto label$1249$129;
	label$1249$123:
	r26 = r20;
	if( r20 == NULL ) hl_null_access();
	r28 = r20->next;
	r20 = r28;
	--r18;
	goto label$1249$134;
	label$1249$129:
	r26 = r23;
	if( r23 == NULL ) hl_null_access();
	r28 = r23->next;
	r23 = r28;
	--r21;
	label$1249$134:
	if( !r22 ) goto label$1249$138;
	if( r22 == NULL ) hl_null_access();
	r22->next = r26;
	goto label$1249$139;
	label$1249$138:
	r14 = r26;
	label$1249$139:
	r22 = r26;
	goto label$1249$102;
	label$1249$141:
	r20 = r23;
	goto label$1249$83;
	label$1249$143:
	if( r22 == NULL ) hl_null_access();
	r29 = NULL;
	r22->next = r29;
	r27 = 1;
	if( r27 < r24 ) goto label$1249$149;
	goto label$1249$153;
	label$1249$149:
	r27 = 2;
	r25 = r2 * r27;
	r2 = r25;
	goto label$1249$73;
	label$1249$153:
	r17 = r14;
	label$1249$154:
	if( r1 == NULL ) hl_null_access();
	r1->lights = r17;
	label$1249$156:
	r14 = r0->shadowLight;
	if( !r14 ) goto label$1249$165;
	r14 = r0->shadowLight;
	if( r14 == NULL ) hl_null_access();
	r2 = r14->flags;
	r18 = 32;
	r2 = r2 & r18;
	r18 = 0;
	if( r2 != r18 ) goto label$1249$177;
	label$1249$165:
	if( r1 == NULL ) hl_null_access();
	r14 = r1->lights;
	label$1249$167:
	if( !r14 ) goto label$1249$177;
	if( r14 == NULL ) hl_null_access();
	r30 = h3d_scene_Light_getShadowDirection(r14);
	if( !r30 ) goto label$1249$174;
	r0->shadowLight = r14;
	goto label$1249$177;
	label$1249$174:
	r17 = r14->next;
	r14 = r17;
	goto label$1249$167;
	label$1249$177:
	return;
}

void h3d_scene_LightSystem_initGlobals(h3d__scene__LightSystem r0,hxsl__Globals r1) {
	String r3;
	bool r5;
	h3d__Vector r4;
	vdynamic *r6;
	if( r1 == NULL ) hl_null_access();
	r3 = (String)global$731;
	r4 = r0->ambientLight;
	hxsl_Globals_set(r1,r3,((vdynamic*)r4));
	r3 = (String)global$732;
	r5 = r0->perPixelLighting;
	r6 = hl_alloc_dynbool(r5);
	hxsl_Globals_set(r1,r3,r6);
	return;
}

int h3d_scene_LightSystem_sortLight(h3d__scene__LightSystem r0,h3d__scene__Light r1,h3d__scene__Light r2) {
	double r6, r7;
	int r3, r4, r5;
	if( r1 == NULL ) hl_null_access();
	r3 = r1->priority;
	if( r2 == NULL ) hl_null_access();
	r4 = r2->priority;
	r3 = r3 - r4;
	r5 = 0;
	if( r3 == r5 ) goto label$1251$9;
	r4 = -r3;
	return r4;
	label$1251$9:
	r6 = r1->objectDistance;
	r7 = r2->objectDistance;
	if( !(r6 < r7) ) goto label$1251$14;
	r4 = -1;
	return r4;
	label$1251$14:
	r4 = 1;
	return r4;
}

hxsl__ShaderList h3d_scene_LightSystem_computeLight(h3d__scene__LightSystem r0,h3d__scene__Object r1,hxsl__ShaderList r2) {
	bool r21;
	hxsl__Shader r31;
	h3d__Camera r13;
	h3d__Vector r12;
	hxsl__ShaderList r30;
	h3d__scene__Light r6, r8, r18, r19, r22, r23, r26, r28, r29;
	vclosure *r17;
	double r9, r11, r14, r15, r16;
	h3d__scene__RenderContext r7;
	h3d__Matrix r10;
	int r4, r5, r20, r24, r25, r27;
	h3d__scene__LightSystem r3;
	r3 = r0;
	r4 = r0->lightCount;
	r5 = r0->maxLightsPerObject;
	if( r5 >= r4 ) goto label$1252$182;
	r7 = r0->ctx;
	if( r7 == NULL ) hl_null_access();
	r6 = r7->lights;
	label$1252$7:
	if( !r6 ) goto label$1252$87;
	if( r1 == NULL ) hl_null_access();
	r4 = r1->flags;
	r5 = 16;
	r4 = r4 & r5;
	r5 = 0;
	if( r4 == r5 ) goto label$1252$56;
	if( r6 == NULL ) hl_null_access();
	r10 = r6->absPos;
	if( r10 == NULL ) hl_null_access();
	r9 = r10->_41;
	r7 = r0->ctx;
	if( r7 == NULL ) hl_null_access();
	r13 = r7->camera;
	if( r13 == NULL ) hl_null_access();
	r12 = r13->target;
	if( r12 == NULL ) hl_null_access();
	r11 = r12->x;
	r9 = r9 - r11;
	r10 = r6->absPos;
	if( r10 == NULL ) hl_null_access();
	r11 = r10->_42;
	r7 = r0->ctx;
	if( r7 == NULL ) hl_null_access();
	r13 = r7->camera;
	if( r13 == NULL ) hl_null_access();
	r12 = r13->target;
	if( r12 == NULL ) hl_null_access();
	r14 = r12->y;
	r11 = r11 - r14;
	r10 = r6->absPos;
	if( r10 == NULL ) hl_null_access();
	r14 = r10->_43;
	r7 = r0->ctx;
	if( r7 == NULL ) hl_null_access();
	r13 = r7->camera;
	if( r13 == NULL ) hl_null_access();
	r12 = r13->target;
	if( r12 == NULL ) hl_null_access();
	r15 = r12->z;
	r14 = r14 - r15;
	r15 = r9 * r9;
	r16 = r11 * r11;
	r15 = r15 + r16;
	r16 = r14 * r14;
	r15 = r15 + r16;
	r6->objectDistance = r15;
	goto label$1252$84;
	label$1252$56:
	if( r6 == NULL ) hl_null_access();
	r10 = r6->absPos;
	if( r10 == NULL ) hl_null_access();
	r9 = r10->_41;
	r10 = r1->absPos;
	if( r10 == NULL ) hl_null_access();
	r11 = r10->_41;
	r9 = r9 - r11;
	r10 = r6->absPos;
	if( r10 == NULL ) hl_null_access();
	r11 = r10->_42;
	r10 = r1->absPos;
	if( r10 == NULL ) hl_null_access();
	r14 = r10->_42;
	r11 = r11 - r14;
	r10 = r6->absPos;
	if( r10 == NULL ) hl_null_access();
	r14 = r10->_43;
	r10 = r1->absPos;
	if( r10 == NULL ) hl_null_access();
	r15 = r10->_43;
	r14 = r14 - r15;
	r15 = r9 * r9;
	r16 = r11 * r11;
	r15 = r15 + r16;
	r16 = r14 * r14;
	r15 = r15 + r16;
	r6->objectDistance = r15;
	label$1252$84:
	r8 = r6->next;
	r6 = r8;
	goto label$1252$7;
	label$1252$87:
	r7 = r0->ctx;
	if( r7 == NULL ) hl_null_access();
	r8 = r7->lights;
	r17 = hl_alloc_closure_ptr(&type$2646,h3d_scene_LightSystem_sortLight,r0);
	if( r8 ) goto label$1252$95;
	r19 = NULL;
	r18 = r19;
	goto label$1252$179;
	label$1252$95:
	r4 = 1;
	r5 = 0;
	r20 = 0;
	label$1252$98:
	r21 = true;
	if( !r21 ) goto label$1252$178;
	r19 = r8;
	r22 = NULL;
	r8 = r22;
	r23 = NULL;
	r22 = r23;
	r25 = 0;
	r24 = r25;
	label$1252$108:
	if( !r19 ) goto label$1252$168;
	++r24;
	r23 = r19;
	r25 = 0;
	r5 = r25;
	r25 = 0;
	r27 = r4;
	label$1252$116:
	if( r25 >= r27 ) goto label$1252$126;
	++r25;
	++r5;
	if( r23 == NULL ) hl_null_access();
	r26 = r23->next;
	r23 = r26;
	if( r26 ) goto label$1252$125;
	goto label$1252$126;
	label$1252$125:
	goto label$1252$116;
	label$1252$126:
	r20 = r4;
	label$1252$127:
	r27 = 0;
	if( r27 < r5 ) goto label$1252$133;
	r27 = 0;
	if( r27 >= r20 ) goto label$1252$166;
	if( !r23 ) goto label$1252$166;
	label$1252$133:
	r27 = 0;
	if( r5 != r27 ) goto label$1252$141;
	r26 = r23;
	if( r23 == NULL ) hl_null_access();
	r28 = r23->next;
	r23 = r28;
	--r20;
	goto label$1252$159;
	label$1252$141:
	r27 = 0;
	if( r20 == r27 ) goto label$1252$148;
	if( !r23 ) goto label$1252$148;
	if( r17 == NULL ) hl_null_access();
	r25 = r17->hasValue ? ((int (*)(vdynamic*,h3d__scene__Light,h3d__scene__Light))r17->fun)((vdynamic*)r17->value,r19,r23) : ((int (*)(h3d__scene__Light,h3d__scene__Light))r17->fun)(r19,r23);
	r27 = 0;
	if( r27 < r25 ) goto label$1252$154;
	label$1252$148:
	r26 = r19;
	if( r19 == NULL ) hl_null_access();
	r28 = r19->next;
	r19 = r28;
	--r5;
	goto label$1252$159;
	label$1252$154:
	r26 = r23;
	if( r23 == NULL ) hl_null_access();
	r28 = r23->next;
	r23 = r28;
	--r20;
	label$1252$159:
	if( !r22 ) goto label$1252$163;
	if( r22 == NULL ) hl_null_access();
	r22->next = r26;
	goto label$1252$164;
	label$1252$163:
	r8 = r26;
	label$1252$164:
	r22 = r26;
	goto label$1252$127;
	label$1252$166:
	r19 = r23;
	goto label$1252$108;
	label$1252$168:
	if( r22 == NULL ) hl_null_access();
	r29 = NULL;
	r22->next = r29;
	r27 = 1;
	if( r27 < r24 ) goto label$1252$174;
	goto label$1252$178;
	label$1252$174:
	r27 = 2;
	r25 = r4 * r27;
	r4 = r25;
	goto label$1252$98;
	label$1252$178:
	r18 = r8;
	label$1252$179:
	r7 = r0->ctx;
	if( r7 == NULL ) hl_null_access();
	r7->lights = r18;
	label$1252$182:
	if( r3 == NULL ) hl_null_access();
	r7 = r3->ctx;
	if( r7 == NULL ) hl_null_access();
	r31 = r0->ambientShader;
	r30 = h3d_scene_RenderContext_allocShaderList(r7,r31,r2);
	r2 = r30;
	r7 = r0->ctx;
	if( r7 == NULL ) hl_null_access();
	r6 = r7->lights;
	r4 = 0;
	label$1252$192:
	if( !r6 ) goto label$1252$209;
	r5 = r4;
	++r4;
	r20 = r0->maxLightsPerObject;
	if( r5 != r20 ) goto label$1252$199;
	goto label$1252$209;
	label$1252$199:
	if( r3 == NULL ) hl_null_access();
	r7 = r3->ctx;
	if( r7 == NULL ) hl_null_access();
	if( r6 == NULL ) hl_null_access();
	r31 = r6->shader;
	r30 = h3d_scene_RenderContext_allocShaderList(r7,r31,r2);
	r2 = r30;
	r8 = r6->next;
	r6 = r8;
	goto label$1252$192;
	label$1252$209:
	return r2;
}

void h3d_scene_LightSystem_new(h3d__scene__LightSystem r0) {
	bool r1;
	h3d__shader__AmbientLight r12;
	h3d__Vector r3;
	double r4, r6, r8;
	double *r5, *r7, *r9, *r10;
	int r2;
	r1 = true;
	r0->perPixelLighting = r1;
	r2 = 6;
	r0->maxLightsPerObject = r2;
	r3 = (h3d__Vector)hl_alloc_obj(h3d__Vector__val);
	r4 = 0.5;
	r5 = &r4;
	r6 = 0.5;
	r7 = &r6;
	r8 = 0.5;
	r9 = &r8;
	r10 = NULL;
	h3d_Vector_new(r3,r5,r7,r9,r10);
	r0->ambientLight = r3;
	r12 = (h3d__shader__AmbientLight)hl_alloc_obj(h3d__shader__AmbientLight__val);
	h3d_shader_AmbientLight_new(r12);
	r0->ambientShader = ((hxsl__Shader)r12);
	r1 = true;
	r1 = h3d_scene_LightSystem_set_additiveLighting(r0,r1);
	return;
}

