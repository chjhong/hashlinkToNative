// Generated by HLC 4.0.0 (HL v4)
#include <hl/code.h>

void h3d_prim_ModelCache_dispose(h3d__prim__ModelCache r0) {
	haxe__ds__StringMap r1;
	bool r4;
	vclosure *r5, *r7;
	vdynamic *r3;
	h3d__mat__Texture r6;
	r1 = (haxe__ds__StringMap)hl_alloc_obj(haxe__ds__StringMap__val);
	haxe_ds_StringMap_new(r1);
	r0->anims = r1;
	r1 = (haxe__ds__StringMap)hl_alloc_obj(haxe__ds__StringMap__val);
	haxe_ds_StringMap_new(r1);
	r0->models = r1;
	r1 = r0->textures;
	if( r1 == NULL ) hl_null_access();
	r3 = haxe_ds_StringMap_iterator(r1);
	label$3001$9:
	if( r3 == NULL ) hl_null_access();
	r5 = (vclosure*)hl_dyn_getp((vdynamic*)r3,407283053/*hasNext*/,&type$118);
	if( r5 == NULL ) hl_null_access();
	r4 = r5->hasValue ? ((bool (*)(vdynamic*))r5->fun)((vdynamic*)r5->value) : ((bool (*)(void))r5->fun)();
	if( !r4 ) goto label$3001$21;
	r7 = (vclosure*)hl_dyn_getp((vdynamic*)r3,151160317/*next*/,&type$101);
	if( r7 == NULL ) hl_null_access();
	r6 = r7->hasValue ? ((h3d__mat__Texture (*)(vdynamic*))r7->fun)((vdynamic*)r7->value) : ((h3d__mat__Texture (*)(void))r7->fun)();
	if( r6 == NULL ) hl_null_access();
	h3d_mat_Texture_dispose(r6);
	goto label$3001$9;
	label$3001$21:
	r1 = (haxe__ds__StringMap)hl_alloc_obj(haxe__ds__StringMap__val);
	haxe_ds_StringMap_new(r1);
	r0->textures = r1;
	return;
}

hxd__fmt__hmd__Library h3d_prim_ModelCache_loadLibrary(h3d__prim__ModelCache r0,hxd__res__Model r1) {
	hxd__fs__FileEntry r3;
	String r2;
	haxe__ds__StringMap r6;
	vdynamic *r5;
	hxd__fmt__hmd__Library r7, r8;
	if( r1 == NULL ) hl_null_access();
	r3 = r1->entry;
	if( r3 == NULL ) hl_null_access();
	r2 = ((String (*)(hxd__fs__FileEntry))r3->$type->vobj_proto[15])(r3);
	r6 = r0->models;
	if( r6 == NULL ) hl_null_access();
	r5 = haxe_ds_StringMap_get(r6,r2);
	r7 = (hxd__fmt__hmd__Library)r5;
	if( r7 ) goto label$3002$14;
	r8 = hxd_res_Model_toHmd(r1);
	r7 = r8;
	r6 = r0->models;
	if( r6 == NULL ) hl_null_access();
	haxe_ds_StringMap_set(r6,r2,((vdynamic*)r8));
	label$3002$14:
	return r7;
}

h3d__scene__Object h3d_prim_ModelCache_loadModel(h3d__prim__ModelCache r0,hxd__res__Model r1) {
	venum *r4;
	vclosure *r2, *r3;
	hxd__fmt__hmd__Library r6;
	h3d__scene__Object r5;
	r2 = hl_alloc_closure_ptr(&type$2509,h3d_prim_ModelCache_loadTexture,r0);
	r4 = hl_alloc_enum(&type$2505,0);
	((Enum$2505*)r4)->p0 = (vclosure*)r2;
	((Enum$2505*)r4)->p1 = (hxd__res__Model)r1;
	r3 = hl_alloc_closure_ptr(&type$2504,fun$3009,r4);
	r6 = h3d_prim_ModelCache_loadLibrary(r0,r1);
	if( r6 == NULL ) hl_null_access();
	r5 = hxd_fmt_hmd_Library_makeObject(r6,r3);
	return r5;
}

h3d__mat__Texture h3d_prim_ModelCache_loadTexture(h3d__prim__ModelCache r0,hxd__res__Model r1,String r2) {
	hxd__fs__FileEntry r6;
	String r3, r5, r7, r19, r21, r24;
	hl__types__ArrayObj r20;
	hxd__fs__NotFound r15, r18, r22, r27;
	haxe__ds__StringMap r9;
	bool r17;
	hxd__res__$Loader r14;
	hxd__res__Loader r13;
	hxd__fs__$NotFound r16;
	vdynamic *r8, *r25;
	int r23, r26;
	hxd__res__Any r12;
	h3d__mat__Texture r10, r11;
	hl_trap_ctx trap$0;
	r3 = r2;
	if( !r1 ) goto label$3004$10;
	if( r1 == NULL ) hl_null_access();
	r6 = r1->entry;
	if( r6 == NULL ) hl_null_access();
	r5 = ((String (*)(hxd__fs__FileEntry))r6->$type->vobj_proto[15])(r6);
	r7 = (String)global$708;
	r5 = String___add__(r5,r7);
	r5 = String___add__(r5,r2);
	r3 = r5;
	label$3004$10:
	r9 = r0->textures;
	if( r9 == NULL ) hl_null_access();
	r8 = haxe_ds_StringMap_get(r9,r3);
	r10 = (h3d__mat__Texture)r8;
	if( !r10 ) goto label$3004$16;
	return r10;
	label$3004$16:
	hl_trap(trap$0,r8,label$3004$23);
	r14 = (hxd__res__$Loader)global$152;
	r13 = r14->currentInstance;
	if( r13 == NULL ) hl_null_access();
	r12 = hxd_res_Loader_load(r13,r2);
	hl_endtrap(trap$0);
	goto label$3004$108;
	label$3004$23:
	r16 = (hxd__fs__$NotFound)global$572;
	r17 = hl_BaseType_check(((hl__BaseType)r16),r8);
	if( !r17 ) goto label$3004$107;
	r18 = (hxd__fs__NotFound)r8;
	r15 = r18;
	if( r1 ) goto label$3004$30;
	hl_throw((vdynamic*)r18);
	label$3004$30:
	if( r1 == NULL ) hl_null_access();
	r6 = r1->entry;
	if( r6 == NULL ) hl_null_access();
	r5 = hxd_fs_FileEntry_get_directory(r6);
	r19 = (String)global$8;
	if( r5 == r19 || (r5 && r19 && String___compare(r5,(vdynamic*)r19) == 0) ) goto label$3004$39;
	r19 = (String)global$207;
	r7 = String___add__(r5,r19);
	r5 = r7;
	label$3004$39:
	if( r2 == NULL ) hl_null_access();
	r21 = (String)global$207;
	r20 = String_split(r2,r21);
	if( r20 == NULL ) hl_null_access();
	r8 = hl_types_ArrayObj_pop(r20);
	r19 = (String)r8;
	r7 = String___add__(r5,r19);
	r5 = r7;
	hl_trap(trap$0,r8,label$3004$54);
	r14 = (hxd__res__$Loader)global$152;
	r13 = r14->currentInstance;
	if( r13 == NULL ) hl_null_access();
	r12 = hxd_res_Loader_load(r13,r7);
	hl_endtrap(trap$0);
	goto label$3004$106;
	label$3004$54:
	r16 = (hxd__fs__$NotFound)global$572;
	r17 = hl_BaseType_check(((hl__BaseType)r16),r8);
	if( !r17 ) goto label$3004$105;
	r22 = (hxd__fs__NotFound)r8;
	hl_trap(trap$0,r8,label$3004$98);
	if( r7 == NULL ) hl_null_access();
	r19 = (String)global$207;
	r20 = String_split(r7,r19);
	if( r20 == NULL ) hl_null_access();
	r8 = hl_types_ArrayObj_pop(r20);
	r7 = (String)r8;
	if( r7 == NULL ) hl_null_access();
	r23 = 0;
	r19 = String_charAt(r7,r23);
	if( r19 == NULL ) hl_null_access();
	r24 = String_toLowerCase(r19);
	if( r19 != r24 && (!r19 || !r24 || String___compare(r19,(vdynamic*)r24) != 0) ) goto label$3004$78;
	r21 = String_toUpperCase(r19);
	r23 = 1;
	r25 = NULL;
	r24 = String_substr(r7,r23,r25);
	r21 = String___add__(r21,r24);
	r7 = r21;
	goto label$3004$84;
	label$3004$78:
	r21 = String_toLowerCase(r19);
	r23 = 1;
	r25 = NULL;
	r24 = String_substr(r7,r23,r25);
	r21 = String___add__(r21,r24);
	r7 = r21;
	label$3004$84:
	if( r5 == NULL ) hl_null_access();
	r23 = 0;
	if( r7 == NULL ) hl_null_access();
	r26 = r7->length;
	r26 = -r26;
	r25 = hl_alloc_dynamic(&type$3);
	r25->v.i = r26;
	r21 = String_substr(r5,r23,r25);
	r21 = String___add__(r21,r7);
	r14 = (hxd__res__$Loader)global$152;
	r13 = r14->currentInstance;
	if( r13 == NULL ) hl_null_access();
	r12 = hxd_res_Loader_load(r13,r21);
	hl_endtrap(trap$0);
	goto label$3004$104;
	label$3004$98:
	r16 = (hxd__fs__$NotFound)global$572;
	r17 = hl_BaseType_check(((hl__BaseType)r16),r8);
	if( !r17 ) goto label$3004$103;
	r27 = (hxd__fs__NotFound)r8;
	hl_throw((vdynamic*)r15);
	label$3004$103:
	hl_rethrow((vdynamic*)r8);
	label$3004$104:
	goto label$3004$106;
	label$3004$105:
	hl_rethrow((vdynamic*)r8);
	label$3004$106:
	goto label$3004$108;
	label$3004$107:
	hl_rethrow((vdynamic*)r8);
	label$3004$108:
	if( r12 == NULL ) hl_null_access();
	r11 = hxd_res_Any_toTexture(r12);
	r9 = r0->textures;
	if( r9 == NULL ) hl_null_access();
	haxe_ds_StringMap_set(r9,r3,((vdynamic*)r11));
	return r11;
}

h3d__anim__Animation h3d_prim_ModelCache_loadAnimation(h3d__prim__ModelCache r0,hxd__res__Model r1,String r2) {
	hxd__fs__FileEntry r4;
	String r3, r6, r7;
	haxe__ds__StringMap r9;
	h3d__anim__Animation r10, r11;
	vdynamic *r8;
	if( r1 == NULL ) hl_null_access();
	r4 = r1->entry;
	if( r4 == NULL ) hl_null_access();
	r3 = ((String (*)(hxd__fs__FileEntry))r4->$type->vobj_proto[15])(r4);
	if( !r2 ) goto label$3005$9;
	r7 = (String)global$440;
	r7 = String___add__(r7,r2);
	r6 = String___add__(r3,r7);
	r3 = r6;
	label$3005$9:
	r9 = r0->anims;
	if( r9 == NULL ) hl_null_access();
	r8 = haxe_ds_StringMap_get(r9,r3);
	r10 = (h3d__anim__Animation)r8;
	if( !r10 ) goto label$3005$15;
	return r10;
	label$3005$15:
	r11 = h3d_prim_ModelCache_initAnimation(r0,r1,r2);
	r9 = r0->anims;
	if( r9 == NULL ) hl_null_access();
	haxe_ds_StringMap_set(r9,r3,((vdynamic*)r11));
	return r11;
}

h3d__anim__Animation h3d_prim_ModelCache_initAnimation(h3d__prim__ModelCache r0,hxd__res__Model r1,String r2) {
	h3d__anim__Animation r3;
	hxd__fmt__hmd__Library r4;
	r4 = h3d_prim_ModelCache_loadLibrary(r0,r1);
	if( r4 == NULL ) hl_null_access();
	r3 = hxd_fmt_hmd_Library_loadAnimation(r4,r2);
	return r3;
}

void h3d_prim_ModelCache_new(h3d__prim__ModelCache r0) {
	haxe__ds__StringMap r1;
	r1 = (haxe__ds__StringMap)hl_alloc_obj(haxe__ds__StringMap__val);
	haxe_ds_StringMap_new(r1);
	r0->models = r1;
	r1 = (haxe__ds__StringMap)hl_alloc_obj(haxe__ds__StringMap__val);
	haxe_ds_StringMap_new(r1);
	r0->textures = r1;
	r1 = (haxe__ds__StringMap)hl_alloc_obj(haxe__ds__StringMap__val);
	haxe_ds_StringMap_new(r1);
	r0->anims = r1;
	return;
}

